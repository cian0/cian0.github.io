<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Tone.js JSON Score Player</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        h1 { text-align: center; }
        button { font-size: 1.2em; padding: 10px 20px; margin: 10px; }
        #controls { text-align: center; margin-bottom: 20px; }
        #visualizer { width: 100%; height: 200px; background-color: #f0f0f0; }
    </style>
</head>
<body>
    <h1>Advanced Tone.js JSON Score Player</h1>
    <div id="controls">
        <button id="playBtn">Play</button>
        <button id="stopBtn">Stop</button>
        <button id="rewindBtn">Rewind</button>
    </div>
    <canvas id="visualizer"></canvas>

    <script>
        let score;
        let tracks;

        // Load the JSON file
        fetch('score.json')
            .then(response => response.json())
            .then(data => {
                score = data;
                initializePlayer();
            })
            .catch(error => console.error('Error loading the score:', error));

        function initializePlayer() {
            // Create instruments, effects chains, and sequences for each track
            tracks = score.tracks.map(track => {
                const instrument = new Tone[track.instrument.type](track.instrument.options).toDestination();
                instrument.volume.value = track.volume;

                // Create effects chain
                if (track.effects && track.effects.length > 0) {
                    const effectsChain = track.effects.map(effect => new Tone[effect.type](effect.options));
                    instrument.chain(...effectsChain, Tone.Destination);
                }

                // Create sequence
                const seq = new Tone.Sequence((time, note) => {
                    instrument.triggerAttackRelease(note.pitch, note.duration, time);
                }, track.notes.map(note => ({
                    pitch: note.pitch,
                    duration: note.duration,
                    time: Tone.Time(note.time).toSeconds()
                })), "4n");

                return { instrument, seq };
            });

            // Set up transport
            Tone.Transport.timeSignature = score.timeSignature;
            Tone.Transport.bpm.value = score.tempo;

            // Set up visualizer
            const visualizer = document.getElementById('visualizer');
            const canvasContext = visualizer.getContext('2d');
            const analyser = new Tone.Analyser('waveform', 256);

            // Connect the master output to the analyser
            Tone.Destination.connect(analyser);

            function drawVisualizer() {
                requestAnimationFrame(drawVisualizer);

                const width = visualizer.width;
                const height = visualizer.height;
                const values = analyser.getValue();
                const bufferLength = analyser.size;

                canvasContext.clearRect(0, 0, width, height);
                canvasContext.beginPath();

                const sliceWidth = width / bufferLength;
                let x = 0;

                for (let i = 0; i < bufferLength; i++) {
                    const v = values[i] / 2 + 0.5;
                    const y = v * height;

                    if (i === 0) {
                        canvasContext.moveTo(x, y);
                    } else {
                        canvasContext.lineTo(x, y);
                    }

                    x += sliceWidth;
                }

                canvasContext.lineTo(width, height / 2);
                canvasContext.strokeStyle = 'rgb(0, 0, 0)';
                canvasContext.stroke();
            }

            // Set up play, stop, and rewind buttons
            document.getElementById('playBtn').addEventListener('click', async () => {
                await Tone.start();
                Tone.Transport.start();
                tracks.forEach(track => track.seq.start(0));
                drawVisualizer();
            });

            document.getElementById('stopBtn').addEventListener('click', () => {
                Tone.Transport.stop();
                tracks.forEach(track => track.seq.stop());
            });

            document.getElementById('rewindBtn').addEventListener('click', () => {
                Tone.Transport.position = 0;
            });

            // Set up the canvas size
            function resizeCanvas() {
                visualizer.width = visualizer.clientWidth * window.devicePixelRatio;
                visualizer.height = visualizer.clientHeight * window.devicePixelRatio;
                canvasContext.scale(window.devicePixelRatio, window.devicePixelRatio);
            }

            // Call resizeCanvas initially and on window resize
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
        }
    </script>
</body>
</html>