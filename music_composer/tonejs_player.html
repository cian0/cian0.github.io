<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ToneJS Music Player</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lamejs/1.2.1/lame.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
        button { margin: 10px; padding: 10px 20px; font-size: 16px; }
        #progressBar { width: 300px; height: 20px; background-color: #ddd; margin: 20px auto; }
        #progress { width: 0%; height: 100%; background-color: #4CAF50; }
    </style>
</head>
<body>
    <h1>ToneJS Music Player</h1>
    <button id="playBtn">Play</button>
    <button id="stopBtn">Stop</button>
    <button id="saveMP3Btn">Save as MP3</button>
    <div>
        <strong>Current Section:</strong> <span id="currentSection">-</span>
    </div>
    <div>
        <strong>Current Beat:</strong> <span id="currentBeat">-</span>
    </div>
    <div id="progressBar">
        <div id="progress"></div>
    </div>

    <script>
        let composition;
        let currentSectionIndex = 0;
        let currentBeat = 0;
        const instruments = {};

        // Load the composition JSON
        fetch('tonejs_composition.json')
            .then(response => response.json())
            .then(data => {
                composition = data;
                setupInstruments();
            });

        function setupInstruments() {
            const reverb = new Tone.Reverb(composition.effects.reverb).toDestination();
            const delay = new Tone.FeedbackDelay(composition.effects.delay).connect(reverb);
            const chorus = new Tone.Chorus(composition.effects.chorus).connect(delay);

            instruments.lead = new Tone.Synth().connect(chorus);
            instruments.pad = new Tone.PolySynth().connect(chorus);
            instruments.bass = new Tone.Synth().connect(delay);
            instruments.kick = new Tone.MembraneSynth().connect(reverb);
            instruments.snare = new Tone.NoiseSynth().connect(reverb);
            instruments.hihat = new Tone.MetalSynth().connect(reverb);
            instruments.tom = new Tone.MembraneSynth().connect(reverb);
            instruments.crash = new Tone.MetalSynth().connect(reverb);
        }

        function playSection(sectionIndex) {
            const section = composition.composition[sectionIndex];
            Tone.Transport.bpm.value = section.tempo;

            section.tracks.forEach(track => {
                if (track.type === 'percussion') {
                    playPercussion(track, section.measures);
                } else {
                    playMelody(track, section.measures);
                }
            });

            document.getElementById('currentSection').textContent = section.name;

            Tone.Transport.scheduleRepeat((time) => {
                currentBeat = (currentBeat + 1) % (section.measures * 8);
                document.getElementById('currentBeat').textContent = currentBeat + 1;
                document.getElementById('progress').style.width = `${(currentBeat / (section.measures * 8)) * 100}%`;
            }, '8n');

            if (sectionIndex < composition.composition.length - 1) {
                Tone.Transport.schedule(() => {
                    currentSectionIndex++;
                    playSection(currentSectionIndex);
                }, `+${section.measures}m`);
            }
        }

        function playMelody(track, measures) {
            const synth = instruments[track.type];
            const pattern = new Tone.Sequence((time, note) => {
                synth.triggerAttackRelease(note, '8n', time);
            }, track.notes, '8n');
            pattern.loop = track.repeat !== undefined ? track.repeat : true;
            pattern.loopEnd = `${measures}m`;
            pattern.start(0);
        }

        function playPercussion(track, measures) {
            track.pattern.forEach(instrument => {
                const synth = instruments[instrument.type];
                const pattern = new Tone.Sequence((time, trig) => {
                    if (trig) synth.triggerAttackRelease('C2', '8n', time);
                }, instrument.beats, '8n');
                pattern.loop = true;
                pattern.loopEnd = `${measures}m`;
                pattern.start(0);
            });
        }

        document.getElementById('playBtn').addEventListener('click', () => {
            Tone.start();
            Tone.Transport.stop();
            Tone.Transport.cancel();
            currentSectionIndex = 0;
            currentBeat = 0;
            playSection(currentSectionIndex);
            Tone.Transport.start();
        });

        document.getElementById('stopBtn').addEventListener('click', () => {
            Tone.Transport.stop();
            Tone.Transport.cancel();
            currentBeat = 0;
            document.getElementById('currentSection').textContent = '-';
            document.getElementById('currentBeat').textContent = '-';
            document.getElementById('progress').style.width = '0%';
        });

        document.getElementById('saveMP3Btn').addEventListener('click', exportToMP3);

        async function exportToMP3() {
            const actx = Tone.context;
            const dest = actx.createMediaStreamDestination();
            const recorder = new MediaRecorder(dest.stream);
            
            // Connect all instruments to the MediaStreamDestination
            Object.values(instruments).forEach(instrument => instrument.connect(dest));

            const chunks = [];
            recorder.ondataavailable = evt => chunks.push(evt.data);
            recorder.onstop = () => {
                const blob = new Blob(chunks, { type: 'audio/webm' });
                convertToMP3(blob);
            };

            // Start recording
            recorder.start();

            // Play the composition
            Tone.Transport.stop();
            Tone.Transport.cancel();
            currentSectionIndex = 0;
            currentBeat = 0;
            playSection(currentSectionIndex);
            Tone.Transport.start();

            // Calculate total duration
            const totalDuration = composition.composition.reduce((sum, section) => 
                sum + (section.measures * 4 * 60 / section.tempo) * section.repeat, 0);

            // Stop recording after the composition finishes
            setTimeout(() => {
                recorder.stop();
                Tone.Transport.stop();
                Object.values(instruments).forEach(instrument => instrument.disconnect(dest));
            }, totalDuration * 1000);
        }

        function convertToMP3(blob) {
            const reader = new FileReader();
            reader.onload = function(event) {
                const buffer = event.target.result;
                const wav = lamejs.WavHeader.readHeader(new DataView(buffer));
                const samples = new Int16Array(buffer, wav.dataOffset, wav.dataLen / 2);
                const mp3encoder = new lamejs.Mp3Encoder(wav.channels, wav.sampleRate, 128);
                const mp3Data = [];

                const sampleBlockSize = 1152;
                for (let i = 0; i < samples.length; i += sampleBlockSize) {
                    const sampleChunk = samples.subarray(i, i + sampleBlockSize);
                    const mp3buf = mp3encoder.encodeBuffer(sampleChunk);
                    if (mp3buf.length > 0) {
                        mp3Data.push(mp3buf);
                    }
                }

                const mp3buf = mp3encoder.flush();
                if (mp3buf.length > 0) {
                    mp3Data.push(mp3buf);
                }

                const blob = new Blob(mp3Data, {type: 'audio/mp3'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'music.mp3';
                a.click();
                URL.revokeObjectURL(url);
            };
            reader.readAsArrayBuffer(blob);
        }
    </script>
</body>
</html>