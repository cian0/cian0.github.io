<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Music Player with JSON Score Upload</title>
    <script src="https://unpkg.com/tone"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        h1 { text-align: center; }
        button, input[type="file"] { font-size: 1.2em; padding: 10px 20px; margin: 10px; }
        #controls { text-align: center; margin-bottom: 20px; }
        #visualizer { width: 100%; height: 200px; background-color: #f0f0f0; }
        #debug { font-family: monospace; white-space: pre; }
    </style>
</head>
<body>
    <h1>Advanced Music Player with JSON Score Upload</h1>
    <div id="controls">
        <input type="file" id="fileInput" accept=".json, text/plain">
        <button id="playBtn" disabled>Play</button>
        <button id="stopBtn" disabled>Stop</button>
        <button id="rewindBtn" disabled>Rewind</button>
        <button id="loopBtn" disabled>Loop: Off</button>
    </div>
    <canvas id="visualizer"></canvas>
    <div id="debug"></div>

    <script>
        let score;
        let tracks;
        const fileInput = document.getElementById('fileInput');
        const playBtn = document.getElementById('playBtn');
        const stopBtn = document.getElementById('stopBtn');
        const rewindBtn = document.getElementById('rewindBtn');
        const loopBtn = document.getElementById('loopBtn');
        const visualizer = document.getElementById('visualizer');
        const canvasContext = visualizer.getContext('2d');
        const debugElement = document.getElementById('debug');

        function log(message) {
            console.log(message);
            debugElement.textContent += message + '\n';
        }

        fileInput.addEventListener('change', function(event) {
            const file = event.target.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    score = JSON.parse(e.target.result);
                    initializePlayer();
                    playBtn.disabled = false;
                    stopBtn.disabled = false;
                    rewindBtn.disabled = false;
                    loopBtn.disabled = false;
                } catch (error) {
                    console.error('Error parsing JSON:', error);
                    alert('Invalid JSON file. Please upload a valid score file.');
                }
            };
            reader.readAsText(file);
        });

        function initializePlayer() {      
            log('Initializing player with score:');
            log(JSON.stringify(score, null, 2));

            Tone.Transport.cancel();

            tracks = score.tracks.map(track => {
                log(`Initializing track: ${track.name}`);
                const instruments = [];
                const createInstrument = () => {
                    const instrument = new Tone[track.instrument.type](track.instrument.options).toDestination();
                    instrument.volume.value = track.volume;

                    if (track.effects && track.effects.length > 0) {
                        const effectsChain = track.effects.map(effect => new Tone[effect.type](effect.options));
                        instrument.chain(...effectsChain, Tone.Destination);
                    }
                    return instrument;
                };
                instruments.push(createInstrument());

                return { instruments, name: track.name, createInstrument };
            });

            Tone.Transport.timeSignature = score.timeSignature;
            Tone.Transport.bpm.value = score.tempo;
            log(`Set tempo to ${score.tempo} BPM and time signature to ${score.timeSignature}`);

            // Calculate total duration and set up looping
            const totalDuration = calculateTotalDuration();
            Tone.Transport.loop = false;
            Tone.Transport.loopEnd = totalDuration;
            log(`Total duration: ${totalDuration}`);

            // Schedule notes
            scheduleNotes();

            const analyser = new Tone.Analyser('waveform', 256);
            Tone.Destination.connect(analyser);

            function drawVisualizer() {
                requestAnimationFrame(drawVisualizer);

                const width = visualizer.width;
                const height = visualizer.height;
                const values = analyser.getValue();
                const bufferLength = analyser.size;

                canvasContext.clearRect(0, 0, width, height);
                canvasContext.beginPath();

                const sliceWidth = width / bufferLength;
                let x = 0;

                for (let i = 0; i < bufferLength; i++) {
                    const v = values[i] / 2 + 0.5;
                    const y = v * height;

                    if (i === 0) {
                        canvasContext.moveTo(x, y);
                    } else {
                        canvasContext.lineTo(x, y);
                    }

                    x += sliceWidth;
                }

                canvasContext.lineTo(width, height / 2);
                canvasContext.strokeStyle = 'rgb(0, 0, 0)';
                canvasContext.stroke();
            }

            // Play button handler
            playBtn.onclick = async () => {
                log('Play button clicked');
                await Tone.start();
                log('Tone.js started');
                Tone.Transport.start();
                log('Transport started');
                drawVisualizer();
                log('Visualizer started');
            };

            // Stop button handler
            stopBtn.onclick = () => {
                log('Stop button clicked');
                Tone.Transport.stop();
                log('Playback stopped');
            };

            // Rewind button handler
            rewindBtn.onclick = () => {
                log('Rewind button clicked');
                Tone.Transport.position = 0;
                log('Transport position reset to 0');
            };

            // Loop button handler
            loopBtn.onclick = () => {
                Tone.Transport.loop = !Tone.Transport.loop;
                loopBtn.textContent = `Loop: ${Tone.Transport.loop ? 'On' : 'Off'}`;
                log(`Looping ${Tone.Transport.loop ? 'enabled' : 'disabled'}`);
            };
        }

        function calculateTotalDuration() {
            let maxDuration = 0;
            score.tracks.forEach(track => {
                track.notes.forEach(note => {
                    const noteEnd = Tone.Time(note.time).toSeconds() + Tone.Time(note.duration).toSeconds();
                    if (noteEnd > maxDuration) {
                        maxDuration = noteEnd;
                    }
                });
            });
            return maxDuration;
        }

        
        function scheduleNotes() {
            score.tracks.forEach((track, trackIndex) => {
                track.notes.forEach(note => {
                    const startTime = note.time;
                    const duration = note.duration;
                    Tone.Transport.schedule((time) => {
                        try {
                            if (Array.isArray(note.pitch)) {
                                // Handle chord (multiple pitches)
                                log(`Playing chord: ${note.pitch.join(', ')}, duration: ${duration}, time: ${time}`);
                                note.pitch.forEach((pitch, index) => {
                                    if (index >= tracks[trackIndex].instruments.length) {
                                        tracks[trackIndex].instruments.push(tracks[trackIndex].createInstrument());
                                    }
                                    tracks[trackIndex].instruments[index].triggerAttackRelease(pitch, duration, time);
                                });
                            } else {
                                // Handle single note
                                log(`Playing note: ${note.pitch}, duration: ${duration}, time: ${time}`);
                                tracks[trackIndex].instruments[0].triggerAttackRelease(note.pitch, duration, time);
                            }
                        } catch (error) {
                            console.warn(`Error playing note/chord: ${note.pitch}. Error: ${error.message}`);
                            log(`Warning: Failed to play note/chord: ${note.pitch}. Skipping.`);
                        }
                    }, startTime);
                });
            });
        }

        function resizeCanvas() {
            visualizer.width = visualizer.clientWidth * window.devicePixelRatio;
            visualizer.height = visualizer.clientHeight * window.devicePixelRatio;
            canvasContext.scale(window.devicePixelRatio, window.devicePixelRatio);
        }

        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);
    </script>
</body>
</html>